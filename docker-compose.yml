services:
  # --- Auth Service (Port 5001) ---
  auth-service:
    build:
      context: ./backend/auth-service
    container_name: placement_portal_auth
    restart: unless-stopped
    dns: 
      - 8.8.8.8 
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: 5001
      MONGO_URI: ${MONGO_URI_AUTH}
      JWT_SECRET: ${JWT_SECRET}
      REDIS_URL: ${REDIS_URL}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY}
      SENDER_EMAIL: ${SENDER_EMAIL}
      RECAPTCHA_SECRET_KEY: ${RECAPTCHA_SECRET_KEY}
      TPO_ADMIN_EMAIL: ${TPO_ADMIN_EMAIL}
      SKIP_CAPTCHA_VERIFICATION: ${SKIP_CAPTCHA_VERIFICATION}
    depends_on: [mongo, redis-cache]
    networks: [app-network]

  # --- Profile Service (Port 5002) ---
  profile-service:
    build:
      context: ./backend/profile-service
    container_name: placement_portal_profile
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: 5002
      MONGO_URI: ${MONGO_URI_PROFILE}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
    volumes:
      - profile-uploads:/app/profile-service/uploads
    depends_on: [mongo]
    networks: [app-network]

  # --- Job Service (Port 5003) ---
  job-service:
    build:
      context: ./backend/job-service
    container_name: placement_portal_job
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: 5003
      MONGO_URI: ${MONGO_URI_JOB}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
    depends_on: [mongo]
    networks: [app-network]

  # --- Application Service (Port 5004) ---
  application-service:
    build:
      context: ./backend/application-service
    container_name: placement_portal_application
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: 5004
      MONGO_URI: ${MONGO_URI_APP}
      PROFILE_SERVICE_URL: ${PROFILE_SERVICE_URL}
      JOB_SERVICE_URL: ${JOB_SERVICE_URL}
      NOTIFICATION_SERVICE_URL: ${NOTIFICATION_SERVICE_URL}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
    depends_on: [mongo, profile-service, job-service]
    networks: [app-network]

  # --- Notification Service (Port 5005) ---
  notification-service:
    build:
      context: ./backend/notification-service
    container_name: placement_portal_notification
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: 5005
      MONGO_URI: ${MONGO_URI_NOTIFY}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
    depends_on: [mongo]
    networks: [app-network]

  # --- Skills Service (Port 5006) ---
  skills-service:
    build:
      context: ./backend/skills-service
    container_name: placement_portal_skills
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: 5006
    networks: [app-network]

  # --- Quiz Service (Port 5007) ---
  quiz-service:
    build:
      context: ./backend/quiz-service
    container_name: placement_portal_quiz
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: 5007
      MONGO_URI: ${MONGO_URI_QUIZ}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
      APPLICATION_SERVICE_URL: ${APPLICATION_SERVICE_URL}
      PROFILE_SERVICE_URL: ${PROFILE_SERVICE_URL}
    depends_on: [mongo]
    networks: [app-network]

  # --- Announcement Service (Port 5008) ---
  announcement-service:
    build:
      context: ./backend/announcement-service
    container_name: placement_portal_announcement
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: 5008
      MONGO_URI: ${MONGO_URI_ANNOUNCE}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
    depends_on: [mongo]
    networks: [app-network]

  # --- Hackathon Service (Port 5009) ---
  hackathon-service:
    build:
      context: ./backend/hackathon-service
    container_name: placement_portal_hackathon
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: 5009
      MONGO_URI: ${MONGO_URI_HACKATHON}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
    depends_on: [mongo]
    networks: [app-network]

  # --- Messaging Service (Port 5012) ---
  messaging-service:
    build:
      context: ./backend/messaging-service
    container_name: placement_portal_messaging
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: 5012
      MONGO_URI: ${MONGO_URI_MESSAGING}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
      JWT_SECRET: ${JWT_SECRET}
    depends_on: [mongo]
    networks: [app-network]

  # --- Task Service (Port 5010) (NEW) ---
  task-service:
    build:
      context: ./backend/task-service
    container_name: placement_portal_task
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: 5010
      MONGO_URI: ${MONGO_URI_TASK}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL}
      JUDGE0_API_KEY: ${JUDGE0_API_KEY}
      JUDGE0_API_HOST: ${JUDGE0_API_HOST}
    depends_on: [mongo]
    networks: [app-network]

  # --- Interview Service (Port 5011) --- 
  interview-service:
    build:
      context: ./backend/interview-service
    container_name: placement_portal_interview
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: 5011
      MONGO_URI: ${MONGO_URI_INTERVIEW}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      AUTH_SERVICE_URL: http://auth-service:5001
    depends_on: [mongo]
    networks: [app-network]

  # --- API Gateway (Nginx) ---
  api-gateway:
    image: nginx:stable-alpine
    container_name: placement_portal_gateway
    restart: unless-stopped
    ports:
      - "5000:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - messaging-service
      - auth-service
      - profile-service
      - job-service
      - application-service
      - notification-service
      - skills-service
      - quiz-service
      - announcement-service
      - hackathon-service
      - task-service
      - interview-service
    networks: [app-network]

  # --- Frontend Service (React) ---
  frontend:
    build:
      context: ./frontend
      args:
        - REACT_APP_RECAPTCHA_SITE_KEY=${REACT_APP_RECAPTCHA_SITE_KEY}
    container_name: placement_portal_frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    networks: [app-network]

  # --- Database & Cache ---
  mongo:
    image: mongo:latest
    container_name: placement_portal_mongo
    restart: unless-stopped
    # Expose mongo to host so tools like MongoDB Compass can connect
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    networks: [app-network]

  redis-cache:
    image: redis:alpine
    container_name: placement_portal_redis
    restart: unless-stopped
    networks: [app-network]

volumes:
  mongo-data:
  profile-uploads:

networks:
  app-network:
    driver: bridge