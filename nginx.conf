# plac_final/nginx.conf
# plac_final/nginx.conf

map $request_method $cors_method {
    OPTIONS 11;
    GET 1;
    POST 1;
    PUT 1;
    DELETE 1;
    PATCH 1;
    default 0;
}

server {
    listen 80;
    server_name localhost;
    client_max_body_size 10M;

    # Default CORS headers (applies at server level so preflight 204 responses include headers)
    # Reflect the request Origin so credentials can be used from the browser
    add_header 'Access-Control-Allow-Origin' $http_origin always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS, PATCH' always;
    add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Student-Id' always;
    add_header 'Access-Control-Max-Age' 86400 always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;

    resolver 127.0.0.11 valid=10s;
    # Define upstream service names as server-level variables so nginx
    # always has them initialized (avoids uninitialized-variable warnings).
    set $upstream_auth auth-service:5001;
    set $upstream_profile profile-service:5002;
    set $upstream_job job-service:5003;
    set $upstream_application application-service:5004;
    set $upstream_notification notification-service:5005;
    set $upstream_skills skills-service:5006;
    set $upstream_quiz quiz-service:5007;
    set $upstream_announcement announcement-service:5008;
    set $upstream_hackathon hackathon-service:5009;
    set $upstream_task task-service:5010;
    set $upstream_interview interview-service:5011;
    set $upstream_messaging messaging-service:5012;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Student-Id $http_x_student_id;
    # Prevent upstream services from sending CORS headers directly (avoid duplicate values)
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Max-Age;
    proxy_hide_header Access-Control-Allow-Credentials;

    location /health {
        return 200 'API Gateway OK';
        add_header Content-Type text/plain;
    }

    location ~ ^/api/auth(/|$) {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        rewrite ^/api/auth(/.*) $1 break;
        rewrite ^/api/auth$ / break;
        proxy_pass http://$upstream_auth;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
    }

    location ~ ^/api/profile(/|$) {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        rewrite ^/api/profile(/.*) $1 break;
        rewrite ^/api/profile$ / break;
        proxy_pass http://$upstream_profile;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /uploads {
        set $upstream_profile profile-service:5002;
        proxy_pass http://$upstream_profile;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location ~ ^/api/jobs(/|$) {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        rewrite ^/api/jobs(/.*) $1 break;
        rewrite ^/api/jobs$ / break;
        proxy_pass http://$upstream_job;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location ~ ^/api/applications(/|$) {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        rewrite ^/api/applications(/.*) $1 break;
        rewrite ^/api/applications$ / break;
        proxy_pass http://$upstream_application;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location ~ ^/api/notifications(/|$) {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        rewrite ^/api/notifications(/.*) $1 break;
        rewrite ^/api/notifications$ / break;
        proxy_pass http://$upstream_notification;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location ~ ^/api/skills(/|$) {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        rewrite ^/api/skills(/.*) $1 break;
        rewrite ^/api/skills$ / break;
        proxy_pass http://$upstream_skills;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    location ~ ^/api/quiz(/|$) {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        rewrite ^/api/quiz(/.*) $1 break;
        rewrite ^/api/quiz$ / break;
        proxy_pass http://$upstream_quiz;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    location ~ ^/api/announcements(/|$) {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        rewrite ^/api/announcements(/.*) $1 break;
        rewrite ^/api/announcements$ / break;
        proxy_pass http://$upstream_announcement;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location ~ ^/api/hackathons(/|$) {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        rewrite ^/api/hackathons(/.*) $1 break;
        rewrite ^/api/hackathons$ / break;
        proxy_pass http://$upstream_hackathon;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location ~ ^/api/tasks(/|$) {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        rewrite ^/api/tasks(/.*) $1 break;
        rewrite ^/api/tasks$ / break;
        proxy_pass http://$upstream_task;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    	location ~ ^/api/interview(/|$) {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        rewrite ^/api/interview(/.*) $1 break;
        rewrite ^/api/interview$ / break;
        proxy_pass http://$upstream_interview;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Student-Id $http_x_student_id;
    }

    location /api/messaging/ {
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        proxy_pass http://$upstream_messaging/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Student-Id $http_x_student_id;
    }
}
